---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro';

interface Produto {
  nome: string;
  minimo: string;
  preco: string;
}

interface Concorrente {
  id_linha: number;
  nome: string;
  seguimento: string;
  regiao: string;
  site: string;
  instagram: string;
  meta_ads: string;
  google_ads: string;
  ticket_medio: string;
  pedido_minimo: string;
  ameaca: string;
  produtos: Produto[];
}

let concorrentes: Concorrente[] = [];
try {
  const response = await fetch(new URL('/api/concorrentes.json', Astro.url));
  const json = await response.json();
  concorrentes = json.data || [];
} catch (e) { console.error(e); }

const total = concorrentes.length;
const segmentos = [...new Set(concorrentes.map(c => c.seguimento))].filter(Boolean);
const cidades = [...new Set(concorrentes.map(c => c.regiao))].filter(Boolean).sort();

function fixUrl(url: string) {
  if (!url) return '';
  let clean = url.trim();
  return clean.match(/^https?:\/\//) ? clean : 'https://' + clean;
}

function getThreatColor(n: string) {
  const level = n ? n.toUpperCase() : 'BAIXA';
  if (level === 'ALTA') return 'red';
  if (level === 'MEDIA') return 'orange';
  return 'green';
}
---

<Layout title="Dashboard - Nicopel" activeMenuItem="dashboard">

  <div class="page-intro">
    <div>
      <h1>Visão de Mercado</h1>
      <p>Clique no nome da empresa para ver/editar a tabela de produtos.</p>
    </div>
    <div class="actions">
      <a href="/adicionar" class="btn-add"><i class="fas fa-plus"></i> <span class="mobile-hide">Adicionar</span></a>
    </div>
  </div>

  <div class="stats-container">
    <div class="stat-card card-green">
      <div class="stat-header"><span>Total</span><div class="icon-circle"><i class="fas fa-database"></i></div></div>
      <h2>{total}</h2>
    </div>
    <div class="stat-card card-blue">
      <div class="stat-header"><span>Segmentos</span><div class="icon-circle"><i class="fas fa-layer-group"></i></div></div>
      <h2>{segmentos.length}</h2>
    </div>
    <div class="stat-card card-purple">
      <div class="stat-header"><span>Cidades</span><div class="icon-circle"><i class="fas fa-map-marker-alt"></i></div></div>
      <h2>{cidades.length}</h2>
    </div>
  </div>

  <div class="toolbar">
    <div class="filter-group">
      <label>Segmento:</label>
      <select id="filterSegmento" class="control-input">
        <option value="todos">Todos</option>
        {segmentos.map(s => <option value={s}>{s}</option>)}
      </select>
    </div>
    <div class="filter-group">
      <label>Cidade:</label>
      <select id="filterCidade" class="control-input">
        <option value="todos">Todas</option>
        {cidades.map(c => <option value={c}>{c}</option>)}
      </select>
    </div>
  </div>

  <div class="grid-cards" id="gridCards">
    {concorrentes.map(c => (
      <div class="card-project" data-nome={c.nome} data-regiao={c.regiao} data-seg={c.seguimento}>
        <div class="card-head">
          <div class="icon-box">{c.nome.charAt(0).toUpperCase()}</div>
          <span class={`threat-badge ${getThreatColor(c.ameaca)}`}>{c.ameaca || 'BAIXA'}</span>
        </div>
        
        <!-- BOTÃO DE ABRIR MODAL DE PRODUTOS -->
        <button 
          class="comp-name-btn open-products" 
          data-linha={c.id_linha} 
          data-nome={c.nome}
          data-produtos={JSON.stringify(c.produtos)}
        >
          {c.nome.toUpperCase()} <i class="fas fa-external-link-alt" style="font-size: 0.7em; margin-left: 8px; opacity: 0.5;"></i>
        </button>

        <p class="location"><i class="fas fa-map-pin"></i> {c.regiao}</p>
        <div class="status-row"><span class="status-badge">{c.seguimento}</span></div>
        
        <div class="metrics">
          <div class="metric"><small>Ticket</small><strong>{c.ticket_medio || '-'}</strong></div>
          <div class="metric"><small>Mínimo</small><strong>{c.pedido_minimo || '-'}</strong></div>
        </div>

        <div class="actions-grid">
          {c.site && <a href={fixUrl(c.site)} target="_blank" class="btn-action website"><i class="fas fa-globe"></i> Site</a>}
          {c.instagram && <a href={fixUrl(c.instagram)} target="_blank" class="btn-action instagram"><i class="fab fa-instagram"></i> Insta</a>}
          {c.meta_ads && <a href={fixUrl(c.meta_ads)} target="_blank" class="btn-action meta"><i class="fab fa-facebook"></i> Ads</a>}
          {c.google_ads && <a href={fixUrl(c.google_ads)} target="_blank" class="btn-action google"><i class="fab fa-google"></i> Ads</a>}
        </div>
      </div>
    ))}
  </div>

  <!-- MODAL DE PRODUTOS -->
  <div id="prodModal" class="modal-overlay hidden">
    <div class="modal-card large-modal">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Produtos</h2>
          <p>Gerencie a tabela de preços deste concorrente.</p>
        </div>
        <button id="closeProdModal" class="close-button">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="table-wrapper">
          <table id="prodTable">
            <thead>
              <tr>
                <th>Produto / Item</th>
                <th style="width: 120px;">Qtd. Mínima</th>
                <th style="width: 120px;">Preço Unit.</th>
                <th style="width: 50px;"></th>
              </tr>
            </thead>
            <tbody id="prodTableBody">
              <!-- Linhas via JS -->
            </tbody>
          </table>
        </div>
        <button id="btnAddRow" class="btn-dashed">+ Adicionar Linha</button>
      </div>

      <div class="modal-footer">
        <span id="saveStatus"></span>
        <button id="btnSaveProds" class="btn-save-modal">Salvar Tabela</button>
      </div>
    </div>
  </div>

  <style>
    /* CSS Global + Específico para Modal de Produtos */
    .page-intro { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .btn-add { background: #1E293B; color: white; padding: 0.8rem 1.2rem; border-radius: 30px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    
    .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
    .card-project { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
    
    .card-head { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .icon-box { width: 40px; height: 40px; background: #E6FFF6; color: #00BA88; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; }
    
    .comp-name-btn {
      background: none; border: none; padding: 0; font-size: 1.1rem; font-weight: 800; color: #1A202C;
      text-align: left; cursor: pointer; margin: 0.5rem 0; display: flex; align-items: center; transition: 0.2s;
      font-family: 'Inter', sans-serif; width: 100%;
    }
    .comp-name-btn:hover { color: #00BA88; }

    .location { color: #718096; font-size: 0.8rem; margin-bottom: 0.8rem; }
    .status-badge { background: #F0FDF4; color: #15803D; padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
    .threat-badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; height: fit-content; }
    .threat-badge.red { background: #FECACA; color: #B91C1C; } .threat-badge.orange { background: #FED7AA; color: #C2410C; } .threat-badge.green { background: #DCFCE7; color: #15803D; }

    .metrics { display: flex; gap: 0.8rem; margin: 1rem 0; background: #F8FAFC; padding: 0.8rem; border-radius: 10px; }
    .metric { display: flex; flex-direction: column; }
    .metric small { font-size: 0.6rem; font-weight: 700; color: #718096; text-transform: uppercase; }
    .metric strong { font-size: 0.85rem; color: #1A202C; }

    .actions-grid { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #F1F5F9; }
    .btn-action { display: flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.6rem; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 700; border: 1px solid transparent; }
    .btn-action.website { background: #EEF2FF; color: #4F46E5; } .btn-action.instagram { background: #FDF2F8; color: #DB2777; } .btn-action.meta { background: #EFF6FF; color: #1D4ED8; } .btn-action.google { background: #FFFBEB; color: #B45309; }

    /* Styles do Stats e Toolbar (Mantidos) */
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { padding: 1.5rem; border-radius: 16px; display: flex; flex-direction: column; justify-content: space-between; height: 140px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .card-green { background: linear-gradient(135deg, #00BA88 0%, #008F68 100%); } .card-blue { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); } .card-purple { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
    .stat-header { display: flex; justify-content: space-between; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
    .icon-circle { background: rgba(255,255,255,0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .stat-card h2 { font-size: 2.2rem; margin: 0; font-weight: 800; }

    .toolbar { background: white; padding: 1rem; border-radius: 16px; margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; border: 1px solid #E2E8F0; }
    .filter-group { flex: 1; min-width: 140px; display: flex; flex-direction: column; gap: 0.3rem; }
    .filter-group label { font-size: 0.7rem; font-weight: 700; color: #718096; text-transform: uppercase; }
    .control-input { padding: 0.6rem; border: 1px solid #CBD5E1; border-radius: 8px; background: #F8FAFC; width: 100%; }

    /* --- MODAL --- */
    .hidden { display: none !important; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: flex; justify-content: center; align-items: center; padding: 1rem; }
    .modal-card { background: white; width: 100%; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; }
    .large-modal { max-width: 700px; }

    .modal-header { padding: 1.5rem; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: flex-start; }
    .modal-header h2 { margin: 0; font-size: 1.4rem; color: #1A202C; }
    .modal-header p { margin: 0.2rem 0 0; color: #718096; font-size: 0.9rem; }
    .close-button { background: none; border: none; font-size: 2rem; line-height: 0.8; cursor: pointer; color: #A0AEC0; }

    .modal-body { padding: 1.5rem; overflow-y: auto; }
    
    .table-wrapper { border: 1px solid #E2E8F0; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
    #prodTable { width: 100%; border-collapse: collapse; }
    #prodTable th { background: #F8FAFC; padding: 0.8rem; text-align: left; font-size: 0.75rem; text-transform: uppercase; color: #64748B; font-weight: 700; border-bottom: 1px solid #E2E8F0; }
    #prodTable td { padding: 0.5rem; border-bottom: 1px solid #F1F5F9; }
    
    .tbl-input { width: 100%; padding: 0.5rem; border: 1px solid transparent; border-radius: 4px; font-family: inherit; font-size: 0.9rem; }
    .tbl-input:hover { border-color: #E2E8F0; }
    .tbl-input:focus { outline: none; border-color: #00BA88; background: #F0FDF4; }

    .btn-del-row { color: #EF4444; background: none; border: none; cursor: pointer; padding: 0.4rem; border-radius: 4px; }
    .btn-del-row:hover { background: #FEF2F2; }

    .btn-dashed { width: 100%; padding: 0.8rem; border: 2px dashed #CBD5E1; background: none; color: #64748B; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    .btn-dashed:hover { border-color: #00BA88; color: #00BA88; background: #F0FDF4; }

    .modal-footer { padding: 1.5rem; border-top: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; }
    .btn-save-modal { background: #00BA88; color: white; border: none; padding: 0.8rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 186, 136, 0.3); }
    .btn-save-modal:hover { background: #00966D; }
    
    #saveStatus { font-size: 0.9rem; font-weight: 600; color: #00BA88; }

    @media(max-width:600px) {
      .grid-cards, .stats-container { grid-template-columns: 1fr; }
      .mobile-hide { display: none; }
    }
  </style>

  <script is:inline>
    // Filtros
    const selSegmento = document.getElementById('filterSegmento');
    const selCidade = document.getElementById('filterCidade');
    const grid = document.getElementById('gridCards');
    let cards = Array.from(grid.children);

    function updateGrid() {
      const valSeg = selSegmento.value;
      const valCid = selCidade.value;
      cards.forEach(card => {
        const seg = card.dataset.seg;
        const reg = card.dataset.regiao;
        const matchSeg = valSeg === 'todos' || seg === valSeg;
        const matchCid = valCid === 'todos' || reg === valCid;
        card.style.display = matchSeg && matchCid ? 'flex' : 'none';
      });
    }
    selSegmento.addEventListener('change', updateGrid);
    selCidade.addEventListener('change', updateGrid);

    // Modal de Produtos
    const modal = document.getElementById('prodModal');
    const closeBtn = document.getElementById('closeProdModal');
    const tableBody = document.getElementById('prodTableBody');
    const btnAddRow = document.getElementById('btnAddRow');
    const btnSave = document.getElementById('btnSaveProds');
    const modalTitle = document.getElementById('modalTitle');
    const saveStatus = document.getElementById('saveStatus');
    
    let currentLinha = null;

    function createRow(produto = { nome: '', minimo: '', preco: '' }) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="tbl-input" placeholder="Ex: Copo 200ml" value="${produto.nome}"></td>
        <td><input type="text" class="tbl-input" placeholder="1000" value="${produto.minimo}"></td>
        <td><input type="text" class="tbl-input" placeholder="0,00" value="${produto.preco}"></td>
        <td style="text-align: center;"><button class="btn-del-row"><i class="fas fa-times"></i></button></td>
      `;
      tr.querySelector('.btn-del-row').addEventListener('click', () => tr.remove());
      tableBody.appendChild(tr);
    }

    document.querySelectorAll('.open-products').forEach(btn => {
      btn.addEventListener('click', () => {
        const nome = btn.dataset.nome;
        const linha = btn.dataset.linha;
        const produtos = JSON.parse(btn.dataset.produtos || '[]');
        
        currentLinha = linha;
        modalTitle.innerText = nome;
        tableBody.innerHTML = '';
        saveStatus.innerText = '';

        if (produtos.length > 0) {
          produtos.forEach(p => createRow(p));
        } else {
          createRow(); 
        }
        modal.classList.remove('hidden');
      });
    });

    btnAddRow.addEventListener('click', () => createRow());

    function closeModal() { modal.classList.add('hidden'); }
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target===modal) closeModal(); });

    btnSave.addEventListener('click', async () => {
      if (!currentLinha) return;
      btnSave.innerText = 'Salvando...';
      
      const rows = tableBody.querySelectorAll('tr');
      const novosProdutos = [];
      rows.forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        if (inputs[0].value.trim()) {
          novosProdutos.push({ 
            nome: inputs[0].value.trim(), 
            minimo: inputs[1].value.trim(), 
            preco: inputs[2].value.trim() 
          });
        }
      });

      try {
        const res = await fetch('/api/gerenciar.json', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ linha: currentLinha, produtos: novosProdutos })
        });

        if (res.ok) {
          saveStatus.innerText = '✅ Salvo!';
          setTimeout(() => window.location.reload(), 800);
        } else {
          saveStatus.innerText = '❌ Erro.';
        }
      } catch (e) {
        saveStatus.innerText = '❌ Erro.';
      } finally {
        btnSave.innerText = 'Salvar Tabela';
      }
    });
  </script>
</Layout>
