---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro';

/* ... (Mantenha seu bloco script/interface igual ao anterior) ... */
/* ... Vou colocar apenas o CSS atualizado para responsividade ... */

interface Concorrente {
  nome: string;
  seguimento: string;
  regiao: string;
  site: string;
  instagram: string;
  meta_ads: string;
  google_ads: string;
  ticket_medio: string;
  pedido_minimo: string;
  ameaca: string;
}

let concorrentes: Concorrente[] = [];
try {
  const response = await fetch(new URL('/api/concorrentes.json', Astro.url));
  const json = await response.json();
  concorrentes = json.data || [];
} catch (e) { console.error(e); }

const total = concorrentes.length;
const segmentos = [...new Set(concorrentes.map(c => c.seguimento))].filter(Boolean);
const cidades = [...new Set(concorrentes.map(c => c.regiao))].filter(Boolean).sort();

function fixUrl(url: string) {
  if (!url) return '';
  let clean = url.trim();
  return clean.match(/^https?:\/\//) ? clean : 'https://' + clean;
}

function getThreatColor(nivel: string) {
  const n = nivel ? nivel.toUpperCase() : 'BAIXA';
  if (n === 'ALTA') return 'red';
  if (n === 'MEDIA') return 'orange';
  return 'green';
}
---

<Layout title="Dashboard - Nicopel" activeMenuItem="dashboard">

  <div class="page-intro">
    <div>
      <h1>Visão de Mercado</h1>
      <p>Monitoramento estratégico da concorrência.</p>
    </div>
    <div class="actions">
      <a href="/adicionar" class="btn-add"><i class="fas fa-plus"></i> <span class="mobile-hide">Adicionar</span></a>
    </div>
  </div>

  <div class="stats-container">
    <div class="stat-card card-green">
      <div class="stat-header"><span>Total</span><div class="icon-circle"><i class="fas fa-database"></i></div></div>
      <h2>{total}</h2>
      <div class="stat-footer"><span class="badge">Ativo</span> Base conectada</div>
    </div>
    <div class="stat-card card-blue">
      <div class="stat-header"><span>Segmentos</span><div class="icon-circle"><i class="fas fa-layer-group"></i></div></div>
      <h2>{segmentos.length}</h2>
      <div class="stat-footer"><span class="badge">Filtros</span> Categorias</div>
    </div>
    <div class="stat-card card-purple">
      <div class="stat-header"><span>Cidades</span><div class="icon-circle"><i class="fas fa-map-marker-alt"></i></div></div>
      <h2>{cidades.length}</h2>
      <div class="stat-footer"><span class="badge">Foco</span> PR e SP</div>
    </div>
  </div>

  <div class="toolbar">
    <div class="filter-group">
      <label>Segmento:</label>
      <select id="filterSegmento" class="control-input">
        <option value="todos">Todos</option>
        {segmentos.map(s => <option value={s}>{s}</option>)}
      </select>
    </div>
    <div class="filter-group">
      <label>Cidade:</label>
      <select id="filterCidade" class="control-input">
        <option value="todos">Todas</option>
        {cidades.map(c => <option value={c}>{c}</option>)}
      </select>
    </div>
    <div class="filter-group">
      <label>Ordenar:</label>
      <select id="sortOrder" class="control-input">
        <option value="az">Nome (A-Z)</option>
        <option value="ameaca_desc">Ameaça (Alta)</option>
      </select>
    </div>
  </div>

  <div class="grid-cards" id="gridCards">
    {concorrentes.map(c => (
      <div class="card-project" data-nome={c.nome} data-regiao={c.regiao} data-seg={c.seguimento} data-ameaca={c.ameaca}>
        <div class="card-head">
          <div class="icon-box">{c.nome.charAt(0).toUpperCase()}</div>
          <span class={`threat-badge ${getThreatColor(c.ameaca)}`}>{c.ameaca || 'BAIXA'}</span>
        </div>
        <h3 class="comp-name">{c.nome.toUpperCase()}</h3>
        <p class="location"><i class="fas fa-map-pin"></i> {c.regiao}</p>
        <div class="status-row"><span class="status-badge">{c.seguimento}</span></div>
        
        <div class="metrics">
          <div class="metric"><small>Ticket</small><strong>{c.ticket_medio || '-'}</strong></div>
          <div class="metric"><small>Mínimo</small><strong>{c.pedido_minimo || '-'}</strong></div>
        </div>

        <div class="actions-grid">
          {c.site && <a href={fixUrl(c.site)} target="_blank" class="btn-action website"><i class="fas fa-globe"></i> Site</a>}
          {c.instagram && <a href={fixUrl(c.instagram)} target="_blank" class="btn-action instagram"><i class="fab fa-instagram"></i> Insta</a>}
          {c.meta_ads && <a href={fixUrl(c.meta_ads)} target="_blank" class="btn-action meta"><i class="fab fa-facebook"></i> Ads</a>}
          {c.google_ads && <a href={fixUrl(c.google_ads)} target="_blank" class="btn-action google"><i class="fab fa-google"></i> Ads</a>}
        </div>
      </div>
    ))}
  </div>

  <style>
    .page-intro { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .page-intro h1 { font-size: 1.5rem; margin: 0; color: #1A202C; font-weight: 800; }
    .page-intro p { color: #64748B; margin: 0; font-size: 0.9rem; }
    @media(max-width:600px) { .page-intro h1 { font-size: 1.2rem; } .mobile-hide { display: none; } }

    .btn-add { background: #1E293B; color: white; padding: 0.8rem 1.2rem; border-radius: 30px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: 0.2s; }
    
    /* RESPONSIVIDADE DO GRID (CRÍTICO) */
    .stats-container { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Se ajusta ao tamanho */
      gap: 1rem; margin-bottom: 2rem; 
    }
    
    .grid-cards { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Cards responsivos */
      gap: 1.5rem; 
    }
    
    /* Cards de Stats */
    .stat-card { padding: 1.5rem; border-radius: 16px; display: flex; flex-direction: column; justify-content: space-between; height: 140px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .card-green { background: linear-gradient(135deg, #00BA88 0%, #008F68 100%); }
    .card-blue { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }
    .card-purple { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
    .stat-header { display: flex; justify-content: space-between; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
    .icon-circle { background: rgba(255,255,255,0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .stat-card h2 { font-size: 2.2rem; margin: 0; font-weight: 800; }
    
    /* Toolbar Responsiva */
    .toolbar { background: white; padding: 1rem; border-radius: 16px; margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; border: 1px solid #E2E8F0; }
    .filter-group { flex: 1; min-width: 140px; display: flex; flex-direction: column; gap: 0.3rem; }
    .filter-group label { font-size: 0.7rem; font-weight: 700; color: #718096; text-transform: uppercase; }
    .control-input { padding: 0.6rem; border: 1px solid #CBD5E1; border-radius: 8px; background: #F8FAFC; width: 100%; }

    /* Card Project */
    .card-project { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid transparent; display: flex; flex-direction: column; }
    .card-head { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .icon-box { width: 45px; height: 45px; background: #E6FFF6; color: #00BA88; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.2rem; }
    .threat-badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; height: fit-content; }
    .threat-badge.red { background: #FECACA; color: #B91C1C; }
    .threat-badge.orange { background: #FED7AA; color: #C2410C; }
    .threat-badge.green { background: #DCFCE7; color: #15803D; }

    .comp-name { margin: 0 0 0.2rem 0; font-size: 1.1rem; color: #1A202C; font-weight: 700; }
    .location { color: #718096; font-size: 0.8rem; margin: 0 0 1rem 0; }
    .status-badge { background: #F0FDF4; color: #15803D; padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }

    .metrics { display: flex; gap: 0.8rem; margin: 1rem 0; background: #F8FAFC; padding: 0.8rem; border-radius: 10px; border: 1px solid #F1F5F9; }
    .metric { display: flex; flex-direction: column; }
    .metric small { font-size: 0.6rem; text-transform: uppercase; color: #718096; font-weight: 700; }
    .metric strong { font-size: 0.85rem; color: #1A202C; }

    .actions-grid { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #F1F5F9; }
    .btn-action { display: flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.6rem; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 700; border: 1px solid transparent; }
    .btn-action.website { background: #EEF2FF; color: #4F46E5; border-color: #C7D2FE; }
    .btn-action.instagram { background: #FDF2F8; color: #DB2777; border-color: #FBCFE8; }
    .btn-action.meta { background: #EFF6FF; color: #1D4ED8; border-color: #BFDBFE; }
    .btn-action.google { background: #FFFBEB; color: #B45309; border-color: #FDE68A; }
  </style>

  <script is:inline>
    /* ... (Mesmo Script de antes) ... */
    document.addEventListener('DOMContentLoaded', () => {
      const grid = document.getElementById('gridCards');
      const selSegmento = document.getElementById('filterSegmento');
      const selCidade = document.getElementById('filterCidade');
      const selSort = document.getElementById('sortOrder');
      let cards = Array.from(grid.children);
      const threatWeight = { 'ALTA': 3, 'MEDIA': 2, 'BAIXA': 1, '': 0 };

      function updateGrid() {
        const valSeg = selSegmento.value;
        const valCid = selCidade.value;
        const valSort = selSort.value;

        cards.forEach(card => {
          const seg = card.dataset.seg;
          const reg = card.dataset.regiao;
          const matchSeg = valSeg === 'todos' || seg === valSeg;
          const matchCid = valCid === 'todos' || reg === valCid;
          card.style.display = matchSeg && matchCid ? 'flex' : 'none';
        });

        const sortedCards = cards.sort((a, b) => {
          const nomeA = a.dataset.nome.toLowerCase();
          const nomeB = b.dataset.nome.toLowerCase();
          const ameacaA = a.dataset.ameaca.toUpperCase();
          const ameacaB = b.dataset.ameaca.toUpperCase();

          if (valSort === 'az') return nomeA.localeCompare(nomeB);
          if (valSort === 'ameaca_desc') return threatWeight[ameacaB] - threatWeight[ameacaA];
          return 0;
        });
        sortedCards.forEach(card => grid.appendChild(card));
      }
      
      selSegmento.addEventListener('change', updateGrid);
      selCidade.addEventListener('change', updateGrid);
      selSort.addEventListener('change', updateGrid);

      window.addEventListener('global-search', (e) => {
        const term = e.detail.toLowerCase();
        cards.forEach(card => {
          const text = (card.dataset.nome + ' ' + card.dataset.regiao).toLowerCase();
          card.style.display = text.includes(term) ? 'flex' : 'none';
        });
      });
    });
  </script>
</Layout>