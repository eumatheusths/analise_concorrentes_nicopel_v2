---
// src/pages/editar.astro
import Layout from '../layouts/Layout.astro';

// ... (Interface e Busca de Dados mantidos iguais ao anterior) ...
interface Concorrente {
  nome: string;
  seguimento: string;
  regiao: string;
  site: string;
  instagram: string;
  meta_ads: string;
  google_ads: string;
  ticket_medio: string;
  pedido_minimo: string;
  ameaca: string;
}

let concorrentes: Concorrente[] = [];
try {
  const response = await fetch(new URL('/api/concorrentes.json', Astro.url));
  const json = await response.json();
  concorrentes = json.data || [];
} catch (e) { console.error("Erro API", e); }

const opcoesSegmento = ["POTE E COPO", "SORVETE", "PIZZA", "INDUSTRIAL", "SACOLA", "BOBINA"];
const opcoesAmeaca = ["BAIXA", "MEDIA", "ALTA"];
---

<Layout title="Gerenciar Dados" activeMenuItem="configuracoes">
  
  <div class="manage-container">
    <div class="page-header-flex">
      <div>
        <h1>Gerenciar Dados</h1>
        <p>Edite ou remova registros.</p>
      </div>
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="tableSearchInput" placeholder="Filtrar tabela..." />
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Segmento</th>
            <th>Cidade</th>
            <th>Ameaça</th>
            <th class="actions-col">Ações</th>
          </tr>
        </thead>
        <tbody id="competitor-table-body">
          {concorrentes.length === 0 ? (
            <tr><td colspan="5" style="text-align: center;">Sem dados.</td></tr>
          ) : (
            concorrentes.map((c, index) => (
              <tr data-search-text={`${c.nome} ${c.regiao} ${c.seguimento}`.toLowerCase()}>
                <td class="cell-empresa">{c.nome}</td>
                <td><span class="badge-tag">{c.seguimento}</span></td>
                <td>{c.regiao}</td>
                <td>
                  {c.ameaca === 'ALTA' && <span class="badge-ameaca red">ALTA</span>}
                  {c.ameaca === 'MEDIA' && <span class="badge-ameaca orange">MÉDIA</span>}
                  {(c.ameaca === 'BAIXA' || !c.ameaca) && <span class="badge-ameaca green">BAIXA</span>}
                </td>
                <td class="actions-col">
                  <button class="btn-action btn-edit" data-linha={index + 2} data-json={JSON.stringify(c)}><i class="fas fa-pen"></i></button>
                  <button class="btn-action btn-delete" data-linha={index + 2} data-nome={c.nome}><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>

  <div id="editModalOverlay" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h2>Editar Registro</h2>
        <button id="closeModalBtn" class="close-button">&times;</button>
      </div>
      <form id="editForm" class="modal-form">
        <input type="hidden" name="linha" />
        <div class="form-row">
          <div class="form-group"><label>Nome</label><input type="text" name="nome" required /></div>
          <div class="form-group">
            <label>Segmento</label>
            <select name="seguimento">{opcoesSegmento.map(o => <option value={o}>{o}</option>)}</select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Região</label><input type="text" name="regiao" /></div>
          <div class="form-group">
            <label>Ameaça</label>
            <select name="ameaca">{opcoesAmeaca.map(o => <option value={o}>{o}</option>)}</select>
          </div>
        </div>
        <div class="form-group"><label>Site</label><input type="text" name="site" /></div>
        <div class="form-group"><label>Instagram</label><input type="text" name="instagram" /></div>
        <div class="form-row three-cols">
          <div class="form-group"><label>Ticket</label><input type="text" name="ticket" /></div>
          <div class="form-group"><label>Mínimo</label><input type="text" name="minimo" /></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Meta Ads</label><input type="text" name="edit_link_m" /></div>
          <div class="form-group"><label>Google Ads</label><input type="text" name="edit_link_g" /></div>
        </div>
        <div class="modal-footer">
          <span id="editStatus" class="status-msg"></span>
          <button type="submit" id="btnSaveChanges" class="btn-save-modal">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    /* CSS MANTIDO IGUAL (JÁ ESTAVA RESPONSIVO), APENAS COPIE E COLE O ANTERIOR SE QUISER */
    .manage-container { max-width: 1200px; margin: 0 auto; }
    .page-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .page-header-flex h1 { margin: 0; color: #1A202C; font-size: 1.8rem; }
    .search-box { position: relative; width: 100%; max-width: 320px; }
    .search-box input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid #E2E8F0; border-radius: 12px; background: white; }
    .search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #A0AEC0; }
    
    .table-container { background: white; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow-x: auto; border: 1px solid #E2E8F0; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    th { text-align: left; padding: 1rem 1.5rem; background: #F8FAFC; color: #64748B; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #E2E8F0; }
    td { padding: 1rem 1.5rem; border-bottom: 1px solid #F1F5F9; color: #2D3748; font-size: 0.9rem; }
    
    .badge-tag { background: #F1F5F9; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    .badge-ameaca { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
    .red { background: #FECACA; color: #B91C1C; } .orange { background: #FED7AA; color: #C2410C; } .green { background: #DCFCE7; color: #15803D; }
    .btn-action { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 8px; color: #A0AEC0; font-size: 1rem; margin: 0 0.2rem; }
    .btn-edit:hover { color: #3B82F6; background: #EFF6FF; } .btn-delete:hover { color: #EF4444; background: #FEF2F2; }
    
    /* Modal */
    .hidden { display: none !important; }
    .modal-overlay { position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: flex; justify-content: center; align-items: center; padding: 1rem; }
    .modal-card { background: white; width: 100%; max-width: 650px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; }
    .modal-form { padding: 1.5rem; overflow-y: auto; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
    .three-cols { grid-template-columns: repeat(3, 1fr); }
    .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
    .form-group input, .form-group select { width: 100%; padding: 0.7rem; border: 1px solid #CBD5E1; border-radius: 8px; font-size: 0.9rem; }
    .modal-footer { margin-top: 1rem; padding: 1.5rem; border-top: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; }
    .btn-save-modal { background: #00BA88; color: white; border: none; padding: 0.8rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .status-msg { font-weight: 600; font-size: 0.9rem; } .msg-success { color: #00BA88; } .msg-error { color: #EF4444; }
    @media (max-width: 600px) { .form-row, .three-cols { grid-template-columns: 1fr; } }
  </style>

  <script is:inline>
    // --- IIFE: ISOLAMENTO DE CÓDIGO (BLINDA O MENU DO LAYOUT) ---
    (() => {
      // 1. Filtro da Tabela
      const searchInput = document.getElementById('tableSearchInput');
      const tableBody = document.getElementById('competitor-table-body');
      const allRows = tableBody.querySelectorAll('tr');

      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          allRows.forEach(row => {
            const searchText = row.dataset.searchText;
            row.style.display = searchText.includes(term) ? '' : 'none';
          });
        });
      }

      // 2. Lógica de Exclusão
      tableBody.addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.btn-delete');
        if (deleteButton) {
          const linha = deleteButton.dataset.linha;
          const nome = deleteButton.dataset.nome;
          if (confirm(`Tem certeza que deseja excluir ${nome}?`)) {
            try {
              const res = await fetch('/api/gerenciar.json', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ linha: parseInt(linha) })
              });
              if (res.ok) {
                alert('Registro excluído!');
                deleteButton.closest('tr').remove();
              } else alert('Erro ao excluir.');
            } catch(err) { alert('Erro de conexão.'); }
          }
        }
      });

      // 3. Lógica de Edição
      const modal = document.getElementById('editModalOverlay');
      const closeBtn = document.getElementById('closeModalBtn');
      const formEdit = document.getElementById('editForm');
      const statusMsg = document.getElementById('editStatus');
      const saveBtn = document.getElementById('btnSaveChanges');
      
      tableBody.addEventListener('click', (e) => {
        const editButton = e.target.closest('.btn-edit');
        if (editButton) {
          const dados = JSON.parse(editButton.dataset.json);
          const linha = editButton.dataset.linha;

          formEdit.elements['linha'].value = linha;
          formEdit.elements['nome'].value = dados.nome;
          formEdit.elements['seguimento'].value = dados.seguimento;
          formEdit.elements['regiao'].value = dados.regiao;
          formEdit.elements['ameaca'].value = dados.ameaca || 'BAIXA';
          formEdit.elements['site'].value = dados.site || '';
          formEdit.elements['instagram'].value = dados.instagram || '';
          formEdit.elements['ticket'].value = dados.ticket_medio || '';
          formEdit.elements['minimo'].value = dados.pedido_minimo || '';
          // AdBlock fix
          formEdit.elements['edit_link_m'].value = dados.meta_ads || '';
          formEdit.elements['edit_link_g'].value = dados.google_ads || '';
          
          statusMsg.innerText = '';
          modal.classList.remove('hidden');
        }
      });

      function closeModal() { modal.classList.add('hidden'); }
      if(closeBtn) closeBtn.addEventListener('click', closeModal);
      if(modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      if(formEdit) {
        formEdit.addEventListener('submit', async (e) => {
          e.preventDefault();
          saveBtn.innerText = 'Salvando...';
          saveBtn.disabled = true;
          statusMsg.innerText = '';

          const formData = new FormData(formEdit);
          const data = Object.fromEntries(formData.entries());
          const payload = { ...data, meta_ads: data.edit_link_m, google_ads: data.edit_link_g };

          try {
            const res = await fetch('/api/gerenciar.json', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.ok) {
              statusMsg.innerText = '✅ Atualizado!';
              statusMsg.className = 'status-msg msg-success';
              setTimeout(() => window.location.reload(), 1000);
            } else throw new Error('Erro');
          } catch (err) {
            statusMsg.innerText = '❌ Erro ao salvar.';
            statusMsg.className = 'status-msg msg-error';
          } finally {
            saveBtn.innerText = 'Salvar Alterações';
            saveBtn.disabled = false;
          }
        });
      }
    })();
  </script>
</Layout>
